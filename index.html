<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Burger Ranker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-50 min-h-screen">
  <div id="app"></div>

  <script>
    // App State
    const state = {
      username: '',
      hasUsername: false,
      tempUsername: '',
      rankedBurgers: [],
      leaderboard: [],
      view: 'ranking',
      searchQuery: '',
      searchResults: [],
      aiSearchQuery: '',
      aiSearchResults: '',
      isAiSearching: false,
      showRecommended: true,
      selectedTags: [],
      expandedComments: {},
      draggedIndex: null,
      dragSource: null,
      hasSubmitted: false,
    };

    // Recommended burgers
    const recommendedBurgers = [
      { name: "Raoul's", address: "180 Prince St, NY 10012", place_id: "raouls", source: "Eater", tags: ["Classic", "Upscale"] },
      { name: "J.G. Melon", address: "1291 3rd Ave, NY 10021", place_id: "jgmelon", source: "Timeout", tags: ["Classic", "No-frills"] },
      { name: "Corner Bistro", address: "331 W 4th St, NY 10014", place_id: "corner", source: "Eater", tags: ["Classic", "Dive Bar"] },
      { name: "Shake Shack", address: "Multiple Locations", place_id: "shakeshack", source: "Timeout", tags: ["Chain", "Fast Casual"] },
      { name: "Superiority Burger", address: "119 Avenue A, NY 10009", place_id: "superiority", source: "Eater", tags: ["Vegetarian"] },
      { name: "Emily", address: "Multiple Locations", place_id: "emily", source: "Eater", tags: ["Upscale"] },
      { name: "Minetta Tavern", address: "113 MacDougal St, NY 10012", place_id: "minetta", source: "Eater", tags: ["Upscale", "Classic"] },
      { name: "Burger Joint", address: "119 W 56th St, NY 10019", place_id: "burgerjoint", source: "Timeout", tags: ["Hidden Gem"] },
      { name: "Peter Luger", address: "178 Broadway, Brooklyn", place_id: "luger", source: "Eater", tags: ["Steakhouse"] },
      { name: "Black Tap", address: "Multiple Locations", place_id: "blacktap", source: "Timeout", tags: ["Instagrammable"] },
      { name: "Flip Sigi", address: "324 E 11th St, NY 10003", place_id: "flipsigi", source: "Eater", tags: ["Smash Burger"] },
    ];

    const allTags = ["Classic", "Upscale", "Vegetarian", "Smash Burger", "Fast Casual", "Gastropub", "Dive Bar", "Hidden Gem", "Steakhouse", "Chain", "No-frills", "Instagrammable"];

    // Storage helpers
    function saveToStorage(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function getFromStorage(key) {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    }

    // Load data
    function loadData() {
      const username = localStorage.getItem('burger-username');
      if (username) {
        state.username = username;
        state.hasUsername = true;
      }
      
      const ranking = getFromStorage('burger-ranking');
      if (ranking) state.rankedBurgers = ranking;
      
      updateLeaderboard();
      render();
    }

    // Username handler
    function setUsername() {
      if (!state.tempUsername.trim() || state.tempUsername.length < 3) {
        alert('Username must be at least 3 characters');
        return;
      }
      localStorage.setItem('burger-username', state.tempUsername.trim());
      state.username = state.tempUsername.trim();
      state.hasUsername = true;
      state.tempUsername = '';
      render();
    }

    // Burger functions
    function addBurgerToRanking(place) {
      console.log('addBurgerToRanking called with:', place);
      if (state.rankedBurgers.length >= 10) {
        alert('You can only rank 10 burgers!');
        return;
      }
      if (state.rankedBurgers.some(b => b.place_id === place.place_id)) {
        alert('This burger is already in your ranking!');
        return;
      }
      state.rankedBurgers.push({
        place_id: place.place_id,
        name: place.name,
        address: place.address,
        rating: 5,
        comments: '',
        tags: place.tags || [],
      });
      console.log('Burger added successfully! New ranking:', state.rankedBurgers);
      // DON'T clear search results - keep them visible
      // state.searchResults = [];
      // state.searchQuery = '';
      render();
    }

    function removeBurger(index) {
      state.rankedBurgers.splice(index, 1);
      render();
    }

    function updateBurger(index, field, value) {
      state.rankedBurgers[index][field] = value;
      render();
    }

    function searchBurgers() {
      if (!state.searchQuery.trim()) return;
      const lowerQuery = state.searchQuery.toLowerCase();
      const filtered = recommendedBurgers.filter(b =>
        b.name.toLowerCase().includes(lowerQuery) ||
        b.address.toLowerCase().includes(lowerQuery)
      );
      state.searchResults = filtered.length > 0 ? filtered.slice(0, 5) : [
        { name: state.searchQuery, address: "New York, NY", place_id: `custom-${Date.now()}` }
      ];
      render();
    }

    // AI Search
    async function handleAiSearch() {
      if (!state.aiSearchQuery.trim()) return;
      state.isAiSearching = true;
      state.aiSearchResults = '';
      render();

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [{
              role: 'user',
              content: `You are a NYC burger expert. Based on this request: "${state.aiSearchQuery}", recommend 2-3 specific burger spots in NYC with their neighborhoods. Be concise. Format: Restaurant Name (Neighborhood) - brief reason why.`
            }],
          }),
        });
        const data = await response.json();
        state.aiSearchResults = data.content.filter(b => b.type === 'text').map(b => b.text).join('\n');
      } catch (error) {
        state.aiSearchResults = 'Could not get recommendations. Try the search bar or browse recommended spots below.';
      }
      state.isAiSearching = false;
      render();
    }

    // Drag and drop
    function handleDragStart(index, source) {
      state.draggedIndex = index;
      state.dragSource = source;
    }

    function handleDragOver(e, index) {
      e.preventDefault();
      if (state.dragSource !== 'ranked' || state.draggedIndex === null || state.draggedIndex === index) return;
      const item = state.rankedBurgers[state.draggedIndex];
      state.rankedBurgers.splice(state.draggedIndex, 1);
      state.rankedBurgers.splice(index, 0, item);
      state.draggedIndex = index;
      render();
    }

    function handleDropFromRecommended(e, targetIndex) {
      e.preventDefault();
      if (state.dragSource !== 'recommended' || state.draggedIndex === null) return;
      const burger = recommendedBurgers[state.draggedIndex];
      console.log('Dropping recommended burger:', burger, 'at position:', targetIndex);
      if (state.rankedBurgers.length >= 10) {
        alert('You can only rank 10 burgers!');
        state.draggedIndex = null;
        state.dragSource = null;
        return;
      }
      if (state.rankedBurgers.some(b => b.place_id === burger.place_id)) {
        alert('This burger is already in your ranking!');
        state.draggedIndex = null;
        state.dragSource = null;
        return;
      }
      state.rankedBurgers.splice(targetIndex, 0, { ...burger, rating: 5, comments: '' });
      state.draggedIndex = null;
      state.dragSource = null;
      render();
    }

    // Save ranking
    function saveRanking() {
      if (state.rankedBurgers.length === 0) {
        alert('Please add at least one burger!');
        return;
      }
      saveToStorage('burger-ranking', state.rankedBurgers);
      const submission = {
        burgers: state.rankedBurgers,
        username: state.username || 'Anonymous',
        timestamp: Date.now()
      };
      const submissions = getFromStorage('burger-submissions') || [];
      submissions.push(submission);
      saveToStorage('burger-submissions', submissions);
      state.hasSubmitted = true;
      updateLeaderboard();
      setTimeout(() => {
        state.view = 'leaderboard';
        render();
      }, 1000);
      render();
    }

    // Update leaderboard
    function updateLeaderboard() {
      const submissions = getFromStorage('burger-submissions') || [];
      const burgerScores = {};
      
      submissions.forEach(submission => {
        submission.burgers.forEach((burger, index) => {
          const placeId = burger.place_id || burger.name;
          if (!burgerScores[placeId]) {
            burgerScores[placeId] = {
              name: burger.name,
              address: burger.address,
              place_id: burger.place_id,
              totalPoints: 0,
              totalRatings: 0,
              submissions: 0,
              comments: [],
              tags: burger.tags || [],
            };
          }
          const points = 10 - index;
          burgerScores[placeId].totalPoints += points;
          burgerScores[placeId].totalRatings += burger.rating;
          burgerScores[placeId].submissions += 1;
          if (burger.comments?.trim()) {
            burgerScores[placeId].comments.push({
              text: burger.comments.trim(),
              username: submission.username || 'Anonymous'
            });
          }
        });
      });

      state.leaderboard = Object.values(burgerScores)
        .map(burger => ({
          ...burger,
          avgRating: (burger.totalRatings / burger.submissions).toFixed(1),
        }))
        .sort((a, b) => b.totalPoints - a.totalPoints)
        .slice(0, 20);
    }

    // Render functions
    function render() {
      const app = document.getElementById('app');
      
      if (!state.hasUsername) {
        app.innerHTML = renderUsernameScreen();
        attachUsernameListeners();
        return;
      }

      app.innerHTML = renderMainApp();
      attachMainListeners();
    }

    function renderUsernameScreen() {
      return `
        <div class="min-h-screen flex items-center justify-center p-4">
          <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-6">
              <div class="text-5xl mb-4">üçî</div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome to NYC Burger Ranker!</h1>
              <p class="text-gray-600">Choose a username to get started</p>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                <input
                  type="text"
                  id="username-input"
                  placeholder="Enter username (min 3 characters)"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                />
              </div>
              <button
                id="create-profile-btn"
                class="w-full bg-orange-500 text-white py-3 rounded-lg font-bold hover:bg-orange-600 transition-colors"
              >
                Create Profile
              </button>
              <p class="text-xs text-gray-500 text-center">
                Your username will appear on the leaderboard when you submit rankings!
              </p>
            </div>
          </div>
        </div>
      `;
    }

    function renderMainApp() {
      return `
        <div class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-8 pt-8">
            <h1 class="text-5xl font-bold text-gray-800 mb-2">üçî NYC Burger Ranker</h1>
            <p class="text-gray-600">Rank your top 10 favorite burgers in New York City</p>
            <div class="mt-2">
              <span class="text-sm text-gray-700">Logged in as: <span class="font-bold text-orange-600">@${state.username}</span></span>
            </div>
          </div>

          <div class="flex gap-2 mb-6 bg-white rounded-lg p-1 shadow-sm">
            <button onclick="switchView('ranking')" class="flex-1 py-3 px-4 rounded-md font-medium transition-all ${state.view === 'ranking' ? 'bg-orange-500 text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}">
              My Ranking
            </button>
            <button onclick="switchView('leaderboard')" class="flex-1 py-3 px-4 rounded-md font-medium transition-all ${state.view === 'leaderboard' ? 'bg-orange-500 text-white shadow-sm' : 'text-gray-600 hover:bg-gray-50'}">
              üèÜ Leaderboard
            </button>
          </div>

          ${state.view === 'ranking' ? renderRankingView() : renderLeaderboardView()}
        </div>
      `;
    }

    function renderRankingView() {
      return `
        ${renderSearchBox()}
        ${renderAiSearch()}
        ${renderRecommended()}
        ${renderRankedList()}
        ${state.rankedBurgers.length > 0 ? renderSubmitButton() : ''}
      `;
    }

    function renderSearchBox() {
      // Store search results globally so onclick can access them
      window.currentSearchResults = state.searchResults;
      
      return `
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
          <div class="flex gap-2">
            <div class="flex-1 relative">
              <input
                type="text"
                id="search-input"
                value="${state.searchQuery}"
                placeholder="Search for burger spots in NYC..."
                class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              />
            </div>
            <button onclick="searchBurgers()" class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors">
              Search
            </button>
          </div>
          ${state.searchResults.length > 0 ? `
            <div id="search-results" class="mt-4 space-y-2">
              ${state.searchResults.map((place, idx) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                  <div class="flex-1">
                    <div class="font-medium text-gray-800">${place.name}</div>
                    <div class="text-sm text-gray-600">üìç ${place.address}</div>
                  </div>
                  <button onclick="window.addSearchResult(${idx})" class="add-search-btn bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg">
                    + Add
                  </button>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderAiSearch() {
      return `
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-sm p-6 mb-6 border-2 border-purple-200">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-lg font-bold text-gray-800">‚ú® AI Burger Finder</span>
          </div>
          <div class="flex gap-2 mb-3">
            <input
              type="text"
              id="ai-search-input"
              value="${state.aiSearchQuery}"
              placeholder="E.g., I'm in the West Village, find me a burger spot"
              class="flex-1 px-4 py-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500"
            />
            <button onclick="handleAiSearch()" ${state.isAiSearching ? 'disabled' : ''} class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-300">
              ${state.isAiSearching ? 'Thinking...' : '‚ú® Ask AI'}
            </button>
          </div>
          ${state.aiSearchResults ? `
            <div class="bg-white p-4 rounded-lg border border-purple-200">
              <p class="text-sm text-gray-700 whitespace-pre-line">${state.aiSearchResults}</p>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderRecommended() {
      return `
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">üèÜ Recommended by Eater & Timeout</h3>
            <button onclick="toggleRecommended()" class="text-sm text-orange-600">
              ${state.showRecommended ? 'Hide' : 'Show'}
            </button>
          </div>
          ${state.showRecommended ? `
            <p class="text-sm text-gray-600 mb-4">Drag and drop these into your ranking!</p>
            <div class="grid grid-cols-1 gap-2 max-h-96 overflow-y-auto">
              ${recommendedBurgers.map((burger, idx) => `
                <div
                  draggable="true"
                  ondragstart="handleDragStart(${idx}, 'recommended')"
                  ondragend="handleDragEnd()"
                  class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border-2 border-transparent hover:border-gray-300 cursor-move"
                >
                  <div class="flex-1">
                    <div class="font-medium text-gray-800">${burger.name}</div>
                    <div class="text-xs text-gray-600">${burger.address}</div>
                    <div class="flex gap-1 mt-1">
                      <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">${burger.source}</span>
                      ${burger.tags.slice(0, 2).map(tag => `
                        <span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded">${tag}</span>
                      `).join('')}
                    </div>
                  </div>
                  <button onclick="addBurgerFromRecommended(${idx})" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg ml-2">
                    +
                  </button>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderRankedList() {
      return `
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-1">Your Top Burgers</h2>
          <p class="text-sm text-gray-600 mb-4">${state.rankedBurgers.length} of 10 burgers ranked</p>
          
          ${state.rankedBurgers.length === 0 ? `
            <div class="text-center py-12 text-gray-500">
              <div class="text-6xl mb-4">üçî</div>
              <p>Drag burgers from recommended list or search to add them!</p>
            </div>
          ` : `
            <div
              ondragover="event.preventDefault()"
              ondrop="handleDropFromRecommended(event, ${state.rankedBurgers.length})"
              class="space-y-3"
            >
              ${state.rankedBurgers.map((burger, index) => `
                <div
                  draggable="true"
                  ondragstart="handleDragStart(${index}, 'ranked')"
                  ondragover="handleDragOver(event, ${index})"
                  ondragend="handleDragEnd()"
                  class="border-2 rounded-lg p-4 cursor-move ${state.draggedIndex === index && state.dragSource === 'ranked' ? 'border-orange-500 bg-orange-50 shadow-lg' : 'border-gray-200 bg-white hover:border-orange-300'}"
                >
                  <div class="flex items-start gap-4">
                    <div class="w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0">
                      ${index + 1}
                    </div>
                    <div class="flex-1 space-y-3">
                      <div>
                        <input
                          type="text"
                          value="${burger.name}"
                          onchange="updateBurger(${index}, 'name', event.target.value)"
                          class="font-bold text-gray-800 text-lg w-full border-b border-transparent hover:border-gray-300 focus:border-orange-500 focus:outline-none bg-transparent px-1"
                        />
                        <input
                          type="text"
                          value="${burger.address}"
                          onchange="updateBurger(${index}, 'address', event.target.value)"
                          class="text-sm text-gray-600 w-full border-b border-transparent hover:border-gray-300 focus:border-orange-500 focus:outline-none bg-transparent px-1 mt-1"
                          placeholder="Add address..."
                        />
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600">Rating:</span>
                        <div class="flex gap-1">
                          ${[1, 2, 3, 4, 5].map(star => `
                            <button onclick="updateBurger(${index}, 'rating', ${star})">
                              <span class="${star <= burger.rating ? 'text-yellow-400' : 'text-gray-300'}">‚òÖ</span>
                            </button>
                          `).join('')}
                        </div>
                      </div>
                      <div>
                        <label class="text-sm text-gray-600">üí¨ Comments</label>
                        <textarea
                          onchange="updateBurger(${index}, 'comments', event.target.value)"
                          placeholder="What makes this burger special?"
                          class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 text-sm mt-1"
                          rows="2"
                        >${burger.comments}</textarea>
                      </div>
                      <div>
                        <label class="text-sm text-gray-600">üè∑Ô∏è Labels</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                          ${(burger.tags || []).map((tag, tagIdx) => `
                            <span class="inline-flex items-center gap-1 bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded">
                              ${tag}
                              <button onclick="removeTag(${index}, ${tagIdx})">√ó</button>
                            </span>
                          `).join('')}
                          <select onchange="addTag(${index}, event.target.value); event.target.value=''" class="text-xs border border-gray-300 rounded px-2 py-1">
                            <option value="">+ Add label</option>
                            ${allTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
                          </select>
                        </div>
                      </div>
                    </div>
                    <button onclick="removeBurger(${index})" class="text-red-500 hover:text-red-700 p-2">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    function renderSubmitButton() {
      return `
        <div class="text-center mb-8">
          <button
            onclick="saveRanking()"
            class="bg-green-500 text-white px-8 py-4 rounded-lg text-lg font-bold hover:bg-green-600 shadow-lg"
          >
            ${state.hasSubmitted ? '‚úì Update My Ranking' : 'Submit My Ranking'}
          </button>
          <p class="text-sm text-gray-600 mt-2">Your ranking will be visible on the leaderboard!</p>
        </div>
      `;
    }

    function renderLeaderboardView() {
      const filteredLeaderboard = state.selectedTags.length > 0
        ? state.leaderboard.filter(burger => burger.tags.some(tag => state.selectedTags.includes(tag)))
        : state.leaderboard;

      return `
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
          <div class="flex items-center gap-2 mb-3">
            <span class="font-medium text-gray-800">üîç Filter by labels:</span>
          </div>
          <div class="flex flex-wrap gap-2">
            ${allTags.map(tag => `
              <button
                onclick="toggleTag('${tag}')"
                class="px-3 py-1 rounded-full text-sm ${state.selectedTags.includes(tag) ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
              >
                ${tag}
              </button>
            `).join('')}
            ${state.selectedTags.length > 0 ? `
              <button onclick="clearTags()" class="px-3 py-1 rounded-full text-sm bg-red-100 text-red-700">
                Clear all
              </button>
            ` : ''}
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            üèÜ NYC's Best Burgers
          </h2>

          ${filteredLeaderboard.length === 0 ? `
            <div class="text-center py-12 text-gray-500">
              <div class="text-6xl mb-4">üèÜ</div>
              <p>${state.selectedTags.length > 0 ? 'No burgers match your filters' : 'No submissions yet. Be the first to rank!'}</p>
            </div>
          ` : `
            <div class="space-y-3">
              ${filteredLeaderboard.map((burger, index) => `
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                  <div class="flex items-center gap-4 p-4 hover:bg-gray-100">
                    <div class="w-12 h-12 flex items-center justify-center flex-shrink-0">
                      ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `
                        <div class="w-10 h-10 bg-gray-300 text-gray-700 rounded-full flex items-center justify-center font-bold">
                          ${index + 1}
                        </div>
                      `}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-bold text-gray-800 text-lg">${burger.name}</div>
                      <div class="text-sm text-gray-600">üìç ${burger.address}</div>
                      ${burger.tags?.length > 0 ? `
                        <div class="flex gap-1 mt-1">
                          ${burger.tags.slice(0, 3).map(tag => `
                            <span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded">${tag}</span>
                          `).join('')}
                        </div>
                      ` : ''}
                    </div>
                    <div class="text-right flex-shrink-0">
                      <div class="flex items-center gap-1 justify-end mb-1">
                        <span class="text-yellow-400">‚òÖ</span>
                        <span class="font-bold text-lg">${burger.avgRating}</span>
                      </div>
                      <div class="text-sm text-gray-600">
                        ${burger.submissions} ${burger.submissions === 1 ? 'vote' : 'votes'}
                      </div>
                    </div>
                    ${burger.comments?.length > 0 ? `
                      <button onclick="toggleComments('${burger.place_id}')" class="text-orange-500 hover:text-orange-600 text-sm font-medium">
                        üí¨ ${burger.comments.length}
                      </button>
                    ` : ''}
                  </div>
                  ${burger.comments?.length > 0 && state.expandedComments[burger.place_id] ? `
                    <div class="border-t border-gray-200 bg-white p-4">
                      <div class="text-sm font-medium text-gray-700 mb-3">
                        üí¨ What people are saying (${burger.comments.length}):
                      </div>
                      <div class="space-y-2">
                        ${burger.comments.map(comment => `
                          <div class="text-sm bg-gray-50 p-3 rounded-lg border-l-2 border-orange-500">
                            <div class="text-gray-600 italic">"${typeof comment === 'string' ? comment : comment.text}"</div>
                            <div class="text-xs text-gray-500 mt-1">
                              ‚Äî @${typeof comment === 'string' ? 'Anonymous' : comment.username}
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    // Event listeners
    function attachUsernameListeners() {
      const input = document.getElementById('username-input');
      const btn = document.getElementById('create-profile-btn');
      
      input.addEventListener('input', (e) => {
        state.tempUsername = e.target.value;
      });
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') setUsername();
      });
      
      btn.addEventListener('click', setUsername);
    }

    function attachMainListeners() {
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          state.searchQuery = e.target.value;
        });
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') searchBurgers();
        });
      }

      const aiSearchInput = document.getElementById('ai-search-input');
      if (aiSearchInput) {
        aiSearchInput.addEventListener('input', (e) => {
          state.aiSearchQuery = e.target.value;
        });
        aiSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleAiSearch();
        });
      }
    }

    // Global functions for onclick handlers
    window.switchView = (view) => {
      state.view = view;
      render();
    };

    window.addSearchResult = (idx) => {
      console.log('Adding search result at index:', idx);
      console.log('Current search results:', window.currentSearchResults);
      if (window.currentSearchResults && window.currentSearchResults[idx]) {
        addBurgerToRanking(window.currentSearchResults[idx]);
      } else {
        console.error('Could not find burger at index', idx);
        alert('Error adding burger. Please try again.');
      }
    };

    window.addBurgerFromRecommended = (idx) => {
      console.log('Adding recommended burger at index:', idx);
      console.log('Recommended burger:', recommendedBurgers[idx]);
      if (recommendedBurgers[idx]) {
        addBurgerToRanking(recommendedBurgers[idx]);
      } else {
        console.error('Could not find recommended burger at index', idx);
        alert('Error adding burger. Please try again.');
      }
    };

    window.removeBurger = removeBurger;
    window.updateBurger = updateBurger;
    window.searchBurgers = searchBurgers;
    window.handleAiSearch = handleAiSearch;
    window.saveRanking = saveRanking;

    window.toggleRecommended = () => {
      state.showRecommended = !state.showRecommended;
      render();
    };

    window.toggleTag = (tag) => {
      if (state.selectedTags.includes(tag)) {
        state.selectedTags = state.selectedTags.filter(t => t !== tag);
      } else {
        state.selectedTags.push(tag);
      }
      render();
    };

    window.clearTags = () => {
      state.selectedTags = [];
      render();
    };

    window.toggleComments = (placeId) => {
      state.expandedComments[placeId] = !state.expandedComments[placeId];
      render();
    };

    window.addTag = (index, tag) => {
      if (tag && !state.rankedBurgers[index].tags.includes(tag)) {
        state.rankedBurgers[index].tags.push(tag);
        render();
      }
    };

    window.removeTag = (burgerIndex, tagIndex) => {
      state.rankedBurgers[burgerIndex].tags.splice(tagIndex, 1);
      render();
    };

    window.handleDragStart = handleDragStart;
    window.handleDragOver = handleDragOver;
    window.handleDragEnd = () => {
      state.draggedIndex = null;
      state.dragSource = null;
    };
    window.handleDropFromRecommended = handleDropFromRecommended;

    // Initialize app
    loadData();
  </script>
</body>
</html>
